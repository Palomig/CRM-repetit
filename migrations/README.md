# База данных - Миграции

## Как запустить миграцию

Эта миграция создает новую функциональность канбан досок для управления задачами.

### Что добавляется:

1. **Таблица `boards`** - для хранения канбан досок
2. **Обновление таблицы `tasks`**:
   - Добавляется поле `board_id` - связь с доской
   - Добавляется поле `position` - позиция задачи в колонке
3. **Создание доски по умолчанию** - "Основная доска" с привязкой существующих задач

### Способы запуска миграции:

#### Вариант 1: Через браузер (рекомендуется)

1. Откройте в браузере: `http://your-domain.com/migrations/migrate.php`
2. Миграция выполнится автоматически
3. Вы увидите JSON ответ с результатом

**Важно:** Миграция безопасна для повторного запуска! Она проверяет существование всех колонок и таблиц перед их созданием.

#### Вариант 2: Через командную строку PHP

```bash
php /path/to/CRM-repetit/migrations/migrate.php
```

#### Вариант 3: Через MySQL вручную

Подключитесь к MySQL и выполните:
```sql
source /path/to/CRM-repetit/migrations/001_create_boards_table.sql
```

Или:
```bash
mysql -u username -p database_name < /path/to/CRM-repetit/migrations/001_create_boards_table.sql
```

### После миграции:

1. Обновите страницу задач в браузере
2. Вы увидите новый интерфейс канбан доски
3. Все существующие задачи будут автоматически привязаны к "Основной доске"

### Решение проблем:

**Ошибка "Duplicate column name 'board_id'":**
- Это нормально! Миграция уже была частично применена
- Просто запустите миграцию еще раз - она пропустит существующие колонки
- Новая версия миграции безопасна для повторного запуска

**Ошибка "There is no active transaction":**
- Это ошибка старой версии скрипта миграции
- Обновите код и запустите миграцию снова

**Проверка успешности миграции:**
Выполните в MySQL:
```sql
-- Проверка таблицы boards
SHOW TABLES LIKE 'boards';

-- Проверка колонок в tasks
DESCRIBE tasks;

-- Проверка данных
SELECT * FROM boards;
```

Должны увидеть:
- Таблицу `boards`
- Колонки `board_id` и `position` в таблице `tasks`
- Запись "Основная доска" в таблице `boards`

### Функциональность канбан досок:

- **Вкладки** - создавайте несколько досок и переключайтесь между ними
- **Drag & Drop** - перетаскивайте задачи между колонками (Ожидают, В работе, Завершены)
- **Управление досками** - создавайте, редактируйте и удаляйте доски
- **Управление задачами** - создавайте, редактируйте и удаляйте задачи на досках

### Откат миграции (если нужно):

```sql
-- Удалить добавленные поля из tasks
ALTER TABLE tasks
DROP FOREIGN KEY fk_tasks_board,
DROP COLUMN board_id,
DROP COLUMN position;

-- Удалить таблицу boards
DROP TABLE IF EXISTS boards;
```

## Новые API endpoints:

### Boards API (`/api/boards.php`)

- `GET /api/boards.php` - получить все доски
- `GET /api/boards.php?id=1` - получить одну доску
- `POST /api/boards.php` - создать доску
- `PUT /api/boards.php` - обновить доску
- `DELETE /api/boards.php` - удалить доску

### Tasks API (обновлено)

- Добавлен параметр `board_id` для фильтрации задач по доске
- Добавлена поддержка поля `position` для сортировки задач

## Примечания:

- Перед миграцией рекомендуется сделать резервную копию базы данных
- Миграция выполняется в транзакции, при ошибке изменения откатываются
- После миграции обязательно проверьте работу страницы задач
